/*-----------------------------------------------------------------------
 * This file is part of TrueBlocks-RPC, which is a near-complete rewrite
 * of libjson-rpc-cpp removing anything not directly needed to support
 * an Ethereum RPC client and server. It retains the original license
 * as described in LICENSE.txt
 * @author  Peter Spiess-Knafl <dev@spiessknafl.at>
 * @author  Thomas Jay Rush <jrush@quickblocks.io> (rewrite 2021)
 *---------------------------------------------------------------------*/
#include <algorithm>

#include <gen/gen.h>

using namespace std;
using namespace jsonrpc;

//---------------------------------------------------------------------------------------
extern const char* TEMPLATE_PYTHON_CLIENT_SIGCLASS;
extern const char* TEMPLATE_PYTHON_CLIENT_SIGCONSTRUCTOR;
extern const char* TEMPLATE_PYTHON_CLIENT_SIGMETHOD;
extern const char* TEMPLATE_PYTHON_NAMED_ASSIGNMENT;
extern const char* TEMPLATE_PYTHON_POSITION_ASSIGNMENT;
extern const char* TEMPLATE_PYTHON_METHODCALL;

//---------------------------------------------------------------------------------------
void PythonClientCodeGenerator::generateStub() {
    writeLine("#");
    writeLine("# This file is generated by jsonrpcstub, DO NOT CHANGE IT MANUALLY!");
    writeLine("#");
    writeNewLine();
    writeLine("#");
    writeLine("# To use this client, jsonrpc_pyclient must be installed:");
    writeLine("# pip install jsonrpc_pyclient");
    writeLine("#");
    writeNewLine();
    writeLine("from jsonrpc_pyclient import client");
    writeNewLine();

    writeLine(substitute(TEMPLATE_PYTHON_CLIENT_SIGCLASS, "<stubname>", stubname));
    increaseIndentation();

    writeLine(substitute(TEMPLATE_PYTHON_CLIENT_SIGCONSTRUCTOR, "<stubname>", stubname));
    writeNewLine();

    for (unsigned int i = 0; i < procedures.size(); i++) {
        generateMethod(procedures[i]);
    }

    decreaseIndentation();
    writeNewLine();
}

//---------------------------------------------------------------------------------------
void PythonClientCodeGenerator::generateMethod(Procedure& proc) {
    string procsignature = TEMPLATE_PYTHON_CLIENT_SIGMETHOD;
    replaceAll(procsignature, "<methodname>", normalizeString(proc.GetProcedureName()));

    // generate parameters string
    string params = generateParameterDeclarationList(proc);
    replaceAll(procsignature, "<parameters>", params);

    writeLine(procsignature);
    increaseIndentation();

    generateAssignments(proc);
    writeNewLine();
    generateProcCall(proc);
    writeNewLine();

    decreaseIndentation();
}

//---------------------------------------------------------------------------------------
void PythonClientCodeGenerator::generateAssignments(Procedure& proc) {
    string assignment;
    parameterNameList_t list = proc.GetParameters();
    if (list.size() > 0) {
        param_t declType = proc.GetParameterDeclarationType();
        if (proc.GetParameterDeclarationType() == PARAMS_BY_NAME) {
            writeLine("parameters = {}");
        } else if (proc.GetParameterDeclarationType() == PARAMS_BY_POSITION) {
            writeLine("parameters = []");
        }

        for (parameterNameList_t::iterator it = list.begin(); it != list.end(); ++it) {
            if (declType == PARAMS_BY_NAME) {
                assignment = TEMPLATE_PYTHON_NAMED_ASSIGNMENT;
            } else {
                assignment = TEMPLATE_PYTHON_POSITION_ASSIGNMENT;
            }
            replaceAll(assignment, "<paramname>", it->first);
            writeLine(assignment);
        }
    } else {
        writeLine("parameters = None");
    }
}

//---------------------------------------------------------------------------------------
void PythonClientCodeGenerator::generateProcCall(Procedure& proc) {
    string call;
    call = TEMPLATE_PYTHON_METHODCALL;
    writeLine(substitute(call, "<name>", proc.GetProcedureName()));
    writeLine("return result");
}

//---------------------------------------------------------------------------------------
const char* TEMPLATE_PYTHON_CLIENT_SIGCLASS = "class <stubname>(client.Client):";
const char* TEMPLATE_PYTHON_CLIENT_SIGCONSTRUCTOR =
    "def __init__(self, connector, version='2.0'):\n        super(<stubname>, self).__init__(connector, version)";
const char* TEMPLATE_PYTHON_CLIENT_SIGMETHOD = "def <methodname>(self<parameters>):";
const char* TEMPLATE_PYTHON_NAMED_ASSIGNMENT = "parameters[\'<paramname>\'] = <paramname>";
const char* TEMPLATE_PYTHON_POSITION_ASSIGNMENT = "parameters.append(<paramname>)";
const char* TEMPLATE_PYTHON_METHODCALL = "result = self.call_method(\'<name>\', parameters)";
